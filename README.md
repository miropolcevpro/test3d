# WebAR визуализатор плитки (без 8thWall)

Проект — статическое веб‑приложение для GitHub Pages:
- сканирование пола (hit-test)
- калибровка/фиксация пола
- постановка точек строго по полу (по центральному лучу камеры)
- замыкание контура и заливка выбранной плиткой
- переключение раскладки (прямая / диагональ 45° / вразбежку)
- бордюр по контуру (вкл/выкл + ширина)
- depth-based окклюзия (best-effort, если поддерживается WebXR Depth API)
- локальный каталог плитки (tiles.json) + админка для редактирования и выгрузки JSON

## Важно про поддержку устройств
Полноценный режим разметки и заливки работает в **Chrome на Android** с поддержкой WebXR `immersive-ar` (обычно требуется ARCore).
На iOS (Safari) WebXR `immersive-ar` обычно недоступен. Для iOS понадобится отдельная реализация (native / 8thWall / Lightship) или другой подход.

## Локальный запуск
Статика должна открываться через http(s), иначе `fetch('tiles.json')` будет блокироваться.

Из папки проекта:
```bash
python -m http.server 8080
```
Откройте: http://localhost:8080

## Развёртывание на GitHub Pages
1) Залейте файлы в репозиторий.
2) В настройках репозитория включите GitHub Pages (ветка `main` / папка root).
3) Откройте URL GitHub Pages.

## Админка каталога
`/admin.html` — редактирование `tiles.json` и скачивание обновлённого файла.
На GitHub Pages запись на сервер невозможна, поэтому заменяйте файл в репозитории вручную.

## Заметки по окклюзии
Окклюзия включается, если устройство/браузер отдаёт depth (`frame.getDepthInformation(view)`).
Реализация — best-effort: сравнение глубины фрагмента заливки с глубиной сцены.



## Авто-обновление контента из папки `assets/`

Чтобы при добавлении/замене файлов в `assets/` контент автоматически подтягивался в приложении, используется синхронизация JSON-файлов из структуры папок.

Скрипт **обновляет**:
- `shapes.json` (hero/icon/gallery форм)
- `tiles.json` (texture/preview плитки)

### Правила по папкам
- Шапка формы (hero): `assets/forms/<shapeId>.webp|png|jpg` (или `assets/forms/<shapeId>_hero.*`)
- Иконка формы (thumb): `assets/forms/<shapeId>_thumb.*` (или `assets/forms/<shapeId>_icon.*`)
- Галерея формы: `assets/gallery/<shapeId>/*.(webp|png|jpg)` (например `1.webp`, `2.webp`…)

### Как работает (формы)
Скрипт `scripts/sync-assets.mjs`:
- обновляет `hero/icon/gallery` в `shapes.json` по наличию файлов
- добавляет `?v=<mtime>` к путям, чтобы не залипал кеш на телефонах
- если `*_thumb` отсутствует — генерирует `assets/forms/<shapeId>_thumb.webp` из `hero` (в CI используется `sharp`)
- если появился новый `assets/gallery/<newId>/...` — создаёт новую форму в `shapes.json` (остальные поля можно отредактировать вручную)

### Как работает (плитка)
Правило простое: всё, что лежит в `assets/textures/`, считается доступной плиткой.

- `assets/textures/<key>.(png|jpg|webp)` — **обязательная** текстура
- `assets/previews/<key>.(png|jpg|webp)` — **превью** (если не найдено, используется texture)

Скрипт:
- добавляет новые плитки в `tiles.json` по новым файлам в `assets/textures/`
- удаляет из `tiles.json` плитки, для которых исчезла текстура
- **не перезаписывает** поля, которые вы редактируете руками/через админку (`name`, `tileSizeM`, `recommendedLayouts`) — он обновляет только пути `texture/preview`

#### Опционально: метаданные плитки
Если хотите, чтобы имя/размеры автоматически подхватывались при добавлении новых файлов — можно создать `assets/tiles_meta.json`:

```json
{
  "paver_grey": {
    "name": "Плитка «Серый квадрат»",
    "tileSizeM": { "w": 0.2, "h": 0.2 },
    "recommendedLayouts": ["Прямая", "Диагональ 45°", "Вразбежку"]
  }
}
```

### Локальный запуск
```bash
npm install
npm run sync:assets
```

### GitHub Actions
Workflow `.github/workflows/sync-content.yml` запускает синхронизацию на каждый push в `assets/**`
и автоматически коммитит обновлённые `shapes.json` / `tiles.json` + сгенерированные thumbs.
